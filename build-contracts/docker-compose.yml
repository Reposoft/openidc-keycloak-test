version: '2'
services:
  mysql:
    image: mariadb:10.1
    expose:
      - "3306"
    environment:
      MYSQL_ROOT_PASSWORD: openidctest
      MYSQL_DATABASE: keycloak
      MYSQL_USER: keycloak
      MYSQL_PASSWORD: keycloak
    # Causes: Change Set META-INF/jpa-changelog-1.0.0.Final.xml::1.0.0.Final::sthorger@redhat.com failed.  Error: Specified key was too long; max key length is 767 bytes [Failed SQL: ALTER TABLE keycloak.REALM_SOCIAL_CONFIG ADD PRIMARY KEY (REALM_ID, NAME)]: liquibase.exception.DatabaseException: Specified key was too long; max key length is 767 bytes [Failed SQL: ALTER TABLE keycloak.REALM_SOCIAL_CONFIG ADD PRIMARY KEY (REALM_ID, NAME)]
    #command:
    #  - --character-set-server=utf8mb4
    #  - --collation-server=utf8mb4_unicode_ci
  keycloak:
    build:
      context: ../keycloak-ha-mysql
    image: solsson/keycloak-ha-mysql
    links:
      - mysql
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: openidctest
      MYSQL_DATABASE: keycloak
      MYSQL_USER: keycloak
      MYSQL_PASSWORD: keycloak
      # Workaround for container using legacy Docker links, resulting in
      # "WFLYCTL0211: Cannot resolve expression 'jdbc:mysql://${env.MYSQL_PORT_3306_TCP_ADDR}:${env.MYSQL_PORT_3306_TCP_PORT}
      MYSQL_PORT_3306_TCP_ADDR: mysql
      MYSQL_PORT_3306_TCP_PORT: "3306"
    expose:
      - "8080"
      - "9090"
    # Uncomment the following and docker-compose up keycloak again to export realms
    volumes:
      - ./keycloak-setup/export:/export
    #entrypoint:
    #  - /opt/jboss/keycloak/bin/standalone.sh
    #  - -Dkeycloak.migration.action=export
    #  - -Dkeycloak.migration.provider=dir
    #  - -Dkeycloak.migration.dir=/export
  keycloak-ha:
    build: ./ha
    links:
      - keycloak
    expose:
      - "8080"
    # For local browser; you also need "keycloak" in your hosts file
    ports:
      - "8080:8080"
  httpd-openidc:
    build: ../httpd-openidc
    image: localhost:5000/reposoft/httpd-openidc
    entrypoint:
      - echo
      - "This was just a build job. Exiting."
  openidc:
    build: ./openidc
    depends_on:
      - httpd-openidc
      - keycloak-ha
    # Don't allow direct communication with keycloak; depends on hosting scenario
    #links:
    #  - keycloak
    expose:
      - "80"
    # For local browser; you also need "openidc" in your hosts file
    ports:
      - "80:80"
    volumes:
      - ./html-ajax:/usr/local/apache2/htdocs
  keycloak-setup:
    build: ./keycloak-setup
    links:
      - keycloak
    volumes:
      - ./keycloak-setup/export:/export
  testclient:
    build: ./client-node-request
    links:
      - openidc
      - keycloak
